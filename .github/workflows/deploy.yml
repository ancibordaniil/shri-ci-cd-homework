name: Deploy to Prod

description: "–í—ã–∫–∞—á–∫–∞ –æ–±—Ä–∞–∑–∞ –Ω–∞ –ø—Ä–æ–¥-—Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SSH"

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        description: "–í–µ—Ä—Å–∏—è Docker-–æ–±—Ä–∞–∑–∞ –¥–ª—è –≤—ã–∫–∞—Ç–∫–∏ –≤ –ø—Ä–æ–¥"

jobs:
  deploy:
    name: üöÄ Deploy version to production server
    runs-on: ubuntu-latest
    env:
      REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app
      VERSION: ${{ github.event.inputs.version }}

    steps:
      - name: üìÉ –õ–æ–≥ –≤–µ—Ä—Å–∏–∏ –∏ —Ä–µ–µ—Å—Ç—Ä–∞
        run: |
          echo "–ë—É–¥–µ–º –¥–µ–ø–ª–æ–∏—Ç—å –≤–µ—Ä—Å–∏—é: $VERSION"
          echo "–ò–∑ —Ä–µ–µ—Å—Ç—Ä–∞: $REGISTRY"

      - name: ‚ú® –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–∑–∞ –≤ YCR
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–≥–∞ $VERSION\_latest –≤ YCR..."
          docker manifest inspect $REGISTRY:${VERSION}_latest >/dev/null || {
            echo "‚ùå –û–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º ${VERSION}_latest –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Container Registry";
            exit 1;
          }
          echo "‚úÖ –û–±—Ä–∞–∑ –Ω–∞–π–¥–µ–Ω."

      - name: üöö –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –¥–µ–ø–ª–æ–π
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo "=== –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä ==="

            echo "1. –ü–æ–ª—É—á–µ–Ω–∏–µ YC access token..."
            echo '${{ secrets.YC_SERVICE_KEY }}' > key.json
            echo "key.json —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ —Å–∫—Ä—ã—Ç–æ)"
            ACCESS_TOKEN=$(cat key.json | jq -r .access_token)
            echo "2. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Registry..."
            echo "$ACCESS_TOKEN" | docker login --username oauth --password-stdin cr.yandex

            echo "3. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker stop app || true
            docker rm app || true

            echo "4. –ü—É–ª–ª –æ–±—Ä–∞–∑–∞..."
            docker pull $REGISTRY:${VERSION}_latest

            echo "5. –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker run -d --name app -p 80:3000 $REGISTRY:${VERSION}_latest

            echo "6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker ps | grep app
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω."

      - name: üìä –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ GitHub Issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.inputs.version }} 
          body: |
            üåê –†–µ–ª–∏–∑ **${{ github.event.inputs.version }}** –≤—ã–∫–∞—á–∞–Ω –≤ –ø—Ä–æ–¥ 
            üìÖ –î–∞—Ç–∞: $(date +%F)
            üë§ –ê–≤—Ç–æ—Ä: @${{ github.actor }}
            üì¶ –û–±—Ä–∞–∑: `${{ env.REGISTRY }}:${{ env.VERSION }}_latest`
